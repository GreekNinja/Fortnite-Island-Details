<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fortnite Map Finder - Advanced Charts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.30.1/date_fns.min.js"></script>


    <style>
        :root {
            --dark-background: #121212;
            --dark-panel: #1c1c1c;
            --dark-tag: #2a2d34;
            --bright-yellow: #F8FF00;
            --text-light: #e0e0e0;
            --text-medium: #a0a0a0;
            --text-dark: #000000;
            --red-error: #e53e3e;
            --green-success: #4caf50;
            --chart-green: rgba(4, 224, 158, 1);
            --chart-blue: #5865f2;
        }
        body { background-color: var(--dark-background); font-family: 'Roboto', sans-serif; color: var(--text-light); min-height: 100vh; padding: 2rem 1rem; }
        .container { width: 100%; max-width: 1100px; margin: 0 auto; display: flex; flex-direction: column; gap: 2rem; }
        
        /* Estilos generales (sin cambios) */
        .search-container, .list-section { background-color: var(--dark-panel); padding: 1.5rem; border-radius: 0.5rem; }
        .search-container h2 { font-family: 'Anton', sans-serif; color: var(--text-light); font-size: 2rem; text-align: center; margin-bottom: 0.5rem; }
        .search-container p { text-align: center; color: var(--text-medium); margin-bottom: 1.5rem; }
        .search-box { display: flex; gap: 1rem; }
        #mapCodeInput { flex-grow: 1; background-color: var(--dark-tag); border: 2px solid var(--dark-tag); color: var(--text-light); padding: 0.75rem 1rem; border-radius: 0.25rem; font-size: 1rem; transition: border-color 0.2s ease; }
        #mapCodeInput:focus { outline: none; border-color: var(--bright-yellow); }
        #searchButton { background-color: var(--bright-yellow); color: var(--text-dark); font-family: 'Anton', sans-serif; font-size: 1.25rem; padding: 0.5rem 2rem; border: none; border-radius: 0.25rem; cursor: pointer; transition: transform 0.2s ease; }
        #searchButton:hover { transform: scale(1.05); }
        #mapDetails.map-card { background-color: var(--dark-panel); border-radius: 0.5rem; overflow: hidden; display: grid; grid-template-columns: 1fr 1fr; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5); }
        .map-info-panel { padding: 2rem; display: flex; flex-direction: column; }
        .image-container { background-color: #000; min-height: 400px; }
        #mapImage { width: 100%; height: 100%; object-fit: cover; }
        h1#mapTitle { font-family: 'Anton', sans-serif; color: var(--bright-yellow); font-size: 3.5rem; line-height: 1; text-transform: uppercase; text-shadow: -2px -2px 0 var(--text-dark), 2px -2px 0 var(--text-dark), -2px 2px 0 var(--text-dark), 2px 2px 0 var(--text-dark); margin-bottom: 0.5rem; }
        .creator-info { color: var(--text-medium); font-weight: 500; margin-bottom: 1.5rem; }
        .creator-info span { color: var(--text-light); font-weight: 700; }
        #mapTags { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; min-height: 24px; }
        .tag { background-color: var(--dark-tag); color: var(--text-light); padding: 0.4rem 1rem; border-radius: 0.25rem; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; }
        #mapDescription { color: var(--text-medium); border-left: 3px solid var(--bright-yellow); padding-left: 1rem; margin-bottom: 1.5rem; font-style: italic; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: auto; padding-top: 1.5rem; border-top: 1px solid var(--dark-tag); }
        .stat-item p:first-child { color: var(--text-medium); font-size: 0.8rem; text-transform: uppercase; }
        .stat-item p:last-child { color: var(--text-light); font-weight: 700; font-size: 1.1rem;}
        .stat-item .fa-spin { color: var(--text-medium); }
        .actions-container { margin-top: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        .action-button { display: block; width: 100%; background-color: var(--bright-yellow); color: var(--text-dark); font-family: 'Anton', sans-serif; font-size: 1.5rem; text-align: center; padding: 0.75rem 1rem; border-radius: 0.25rem; text-decoration: none; border: none; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .action-button:hover { transform: scale(1.03); box-shadow: 0 0 15px rgba(248, 255, 0, 0.4); }
        #favoriteButton { background-color: var(--dark-tag); color: var(--text-light); font-size: 1.1rem; }
        #favoriteButton:hover { background-color: #444; box-shadow: none; }
        .map-code-container { background-color: var(--dark-tag); border-radius: 0.25rem; padding: 0.75rem 1rem; display: flex; align-items: center; justify-content: space-between; }
        #mapCodeDisplay { font-weight: 700; letter-spacing: 1px; }
        .copy-icon { color: var(--text-medium); cursor: pointer; transition: color 0.2s ease; }
        .copy-icon:hover { color: var(--text-light); }
        #errorAlert { color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center; font-weight: 500; }
        #errorAlert button { background: rgba(0,0,0,0.2); border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; }
        
        /* --- ESTILOS MEJORADOS PARA GRÁFICOS --- */
        .chart-section { background-color: var(--dark-panel); padding: 1.5rem 2rem; border-radius: 0.5rem; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--dark-tag); padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .chart-header h2 { font-family: 'Anton', sans-serif; font-size: 1.75rem; color: var(--text-light); border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .chart-filters button { background-color: var(--dark-tag); color: var(--text-medium); font-weight: bold; border: none; padding: 0.5rem 1rem; border-radius: 0.25rem; cursor: pointer; transition: background-color 0.2s; }
        .chart-filters button:hover { background-color: #444; }
        .chart-filters button.active { background-color: var(--bright-yellow); color: var(--text-dark); }
        
        .player-count-summary { display: flex; justify-content: space-around; text-align: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;}
        .summary-item .value { font-family: 'Anton', sans-serif; font-size: 3rem; line-height: 1; }
        .summary-item .peak-value { color: var(--chart-green); }
        .summary-item .label { color: var(--text-medium); font-size: 0.9rem; text-transform: uppercase; }
        .summary-item .rank { background-color: var(--dark-tag); color: var(--bright-yellow); font-weight: bold; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-left: 8px; }

        .hidden { display: none !important; }

        @media (max-width: 768px) {
            body { padding: 1rem; }
            #mapDetails.map-card { grid-template-columns: 1fr; }
            .image-container { min-height: 250px; order: -1; }
            .map-info-panel, .chart-section { padding: 1.5rem; }
            h1#mapTitle { font-size: 2.5rem; }
            .search-box, .player-count-summary, .chart-header { flex-direction: column; gap: 1.5rem; }
        }
    </style>
</head>
<body>
    
    <div class="container">
        
        <div id="errorAlert" class="hidden"></div>
        <div class="search-container"></div>

        <div id="mapDetails" class="map-card hidden"></div>

        <div id="playerChartSection" class="chart-section hidden">
            <div class="chart-header">
                <h2>PLAYER COUNT</h2>
                <div class="chart-filters" id="playerChartFilters">
                    <button data-range="1D" class="active">1D</button>
                    <button data-range="7D">7D</button>
                    <button data-range="1M">1M</button>
                    <button data-range="1Y">1Y</button>
                    <button data-range="ALL">ALL</button>
                </div>
            </div>
            <div class="player-count-summary"></div>
            <canvas id="playerChart"></canvas>
        </div>

        <div id="discoveryChartSection" class="chart-section hidden">
            <div class="chart-header">
                <h2>DISCOVERY TIMELINE</h2>
            </div>
            <p class="text-center text-gray-500 mb-4">NOTA: La API para estos datos no está disponible. Este es un ejemplo visual de cómo se vería.</p>
            <canvas id="discoveryChart"></canvas>
        </div>
        
        <div id="historySection" class="list-section hidden"></div>
        <div id="favoritesSection" class="list-section hidden"></div>

    </div>

    <script>
        // --- CONFIG & GLOBAL VARS ---
        const FORTNITEAPI_KEY = "eadee0b6-665fb82d-1a863033-2f764868";
        let searchHistory = JSON.parse(localStorage.getItem("searchHistory")) || [];
        let favoriteMaps = JSON.parse(localStorage.getItem("favoriteMaps")) || [];
        let myPlayerChart = null;
        let myDiscoveryChart = null;
        let fullPlayerData = []; // Almacenar todos los datos de jugadores para filtrar

        // --- INITIALIZATION ---
        document.addEventListener("DOMContentLoaded", () => {
            // Render initial structure from JS to keep HTML clean
            setupInitialHTML();
            renderSearchHistory();
            renderFavorites();
            setupEventListeners();
        });

        function setupInitialHTML() {
            document.querySelector('.search-container').innerHTML = `
                <h2>Fortnite Map Finder</h2>
                <p>Enter a map code to get details.</p>
                <div class="search-box">
                    <input id="mapCodeInput" type="text" placeholder="e.g., 4272-2986-9914">
                    <button id="searchButton">Search</button>
                </div>`;
            document.getElementById('mapDetails').innerHTML = `
                <div class="map-info-panel">
                    <h1 id="mapTitle"></h1>
                    <p class="creator-info">By <span id="mapCreator"></span></p>
                    <div id="mapTags"></div>
                    <p id="mapDescription"></p>
                    <div class="stats-grid">
                        <div class="stat-item"><p>Live Players</p><p id="mapLivePlayers">--</p></div>
                        <div class="stat-item"><p>Peak Players (24h)</p><p id="mapPeakPlayers">--</p></div>
                        <div class="stat-item"><p>Created In</p><p id="mapTool"></p></div>
                        <div class="stat-item"><p>Published</p><p id="mapReleaseDate"></p></div>
                        <div class="stat-item"><p>Age Rating (PEGI)</p><p id="mapAgeRating"></p></div>
                        <div class="stat-item"><p>XP Status</p><p id="mapXPStatus"></p></div>
                    </div>
                    <div class="actions-container">
                        <a id="playNowButton" href="#" target="_blank" class="action-button">PLAY NOW</a>
                        <button id="favoriteButton" class="action-button"><i class="fa-regular fa-star"></i> Save as Favorite</button>
                        <div class="map-code-container">
                            <span id="mapCodeDisplay"></span>
                            <i class="fa-solid fa-copy copy-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="image-container">
                    <img id="mapImage" src="" alt="Map Image" onerror="this.onerror=null; this.src='https://placehold.co/800x800/1c1c1c/a0a0a0?text=No+Image';">
                </div>`;
             document.querySelector('.player-count-summary').innerHTML = `
                <div class="summary-item">
                    <p class="value" id="summaryLive">--</p>
                    <p class="label">Players Right Now <span id="summaryRank" class="rank hidden"></span></p>
                </div>
                <div class="summary-item">
                    <p class="value peak-value" id="summaryPeak24h">--</p>
                    <p class="label">24-Hour Peak</p>
                </div>
                <div class="summary-item">
                    <p class="value" id="summaryPeakAllTime">--</p>
                    <p class="label" id="summaryPeakAllTimeLabel">All-Time Peak</p>
                </div>`;
            document.getElementById('historySection').innerHTML = `<h2><i class="fa-solid fa-clock-rotate-left"></i> Search History</h2><ul id="searchHistory"></ul>`;
            document.getElementById('favoritesSection').innerHTML = `<h2><i class="fa-solid fa-star"></i> Favorite Maps</h2><ul id="favoriteMaps"></ul>`;
            document.getElementById('errorAlert').innerHTML = `<span id="errorText"></span><button onclick="dismissError()">Dismiss</button>`;
        }

        function setupEventListeners() {
            document.getElementById('searchButton').addEventListener('click', () => fetchMapDetails());
            document.getElementById('mapCodeInput').addEventListener("keypress", (event) => {
                if (event.key === "Enter") {
                    event.preventDefault();
                    fetchMapDetails();
                }
            });
            document.getElementById('favoriteButton').addEventListener('click', saveFavorite);
            document.querySelector('.copy-icon').addEventListener('click', copyCode);
            
            // Event listeners para los filtros del gráfico de jugadores
            document.getElementById('playerChartFilters').addEventListener('click', (event) => {
                if (event.target.tagName === 'BUTTON') {
                    const range = event.target.dataset.range;
                    updatePlayerChartRange(range);
                    
                    // Manejar la clase 'active'
                    document.querySelectorAll('#playerChartFilters button').forEach(btn => btn.classList.remove('active'));
                    event.target.classList.add('active');
                }
            });
        }
        
        // --- API FETCHING & DATA HANDLING ---
        async function fetchMapDetails() {
            const mapCode = document.getElementById('mapCodeInput').value.trim();
            if (!mapCode) {
                showError("Please enter a valid map code!");
                return;
            }

            document.getElementById('mapDetails').classList.add("hidden");
            document.getElementById('playerChartSection').classList.add("hidden");
            document.getElementById('discoveryChartSection').classList.add("hidden");

            try {
                const response = await fetch(`https://fortniteapi.io/v1/creative/island?code=${mapCode}`, { headers: { "Authorization": FORTNITEAPI_KEY } });
                const data = await response.json();

                if (!data.result || !data.island) {
                    showError(data.error || "Map not found. Please check the code.");
                    return;
                }
                
                dismissError();
                displayMapDetails(data.island);
                fetchPlayerData(data.island.code);
                saveSearchHistory({ code: data.island.code, title: data.island.title });
            } catch (error) {
                showError("An API error occurred. Please try again later.");
            }
        }
        
        async function fetchPlayerData(islandCode) {
            const liveEl = document.getElementById("mapLivePlayers");
            const peakEl = document.getElementById("mapPeakPlayers");
            liveEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            peakEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(`https://fnzone.es/api/backend/v1/players/${islandCode}`);
                if (!response.ok) throw new Error('Player data not OK');
                
                const data = await response.json();
                if (!data.success) throw new Error('Player data API failure');

                fullPlayerData = data.parsedData.map(d => ({ x: new Date(d.at), y: d.ccu })).reverse();
                
                const peakAllTime = data.highestValue?.ccu ?? 'N/A';
                const peakDate = new Date(data.highestValue.at);

                document.getElementById("summaryLive").innerText = fullPlayerData[fullPlayerData.length - 1].y;
                document.getElementById("summaryPeakAllTime").innerText = peakAllTime;
                document.getElementById("summaryPeakAllTimeLabel").innerText = `All-Time Peak ${peakDate.toLocaleDateString()}`;
                
                if (data.islandTop) {
                    document.getElementById("summaryRank").innerText = data.islandTop;
                    document.getElementById("summaryRank").classList.remove("hidden");
                } else {
                    document.getElementById("summaryRank").classList.add("hidden");
                }

                document.getElementById('playerChartSection').classList.remove("hidden");
                // Por defecto, mostrar 1D
                updatePlayerChartRange('1D');
                document.querySelectorAll('#playerChartFilters button').forEach(btn => btn.classList.remove('active'));
                document.querySelector('#playerChartFilters button[data-range="1D"]').classList.add('active');

                // AÑADIR LLAMADA A LA API DE DISCOVERY AQUÍ CUANDO LA TENGAS
                // fetchDiscoveryData(islandCode);

            } catch (error) {
                liveEl.innerText = 'N/A';
                peakEl.innerText = 'N/A';
                document.getElementById('playerChartSection').classList.add("hidden");
            }
        }
        
        // --- CHARTING FUNCTIONS ---
        function updatePlayerChartRange(range) {
            const now = new Date();
            let startDate;

            switch(range) {
                case '1D':
                    startDate = dateFns.subDays(now, 1);
                    break;
                case '7D':
                    startDate = dateFns.subDays(now, 7);
                    break;
                case '1M':
                    startDate = dateFns.subMonths(now, 1);
                    break;
                case '1Y':
                    startDate = dateFns.subYears(now, 1);
                    break;
                case 'ALL':
                default:
                    startDate = new Date(0); // El inicio de los tiempos
            }
            
            const filteredData = fullPlayerData.filter(d => d.x >= startDate);
            
            const livePlayers = filteredData.length > 0 ? filteredData[filteredData.length - 1].y : 'N/A';
            const peak24h = filteredData.length > 0 ? Math.max(...filteredData.map(d => d.y)) : 'N/A';

            document.getElementById("mapLivePlayers").innerText = livePlayers;
            document.getElementById("mapPeakPlayers").innerText = peak24h;
            document.getElementById("summaryPeak24h").innerText = peak24h;

            createPlayerChart(filteredData);
        }

        function createPlayerChart(data) {
            if (myPlayerChart) myPlayerChart.destroy();
            
            const ctx = document.getElementById('playerChart').getContext('2d');
            myPlayerChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Players',
                        data: data,
                        borderColor: 'var(--chart-green)',
                        backgroundColor: 'rgba(4, 224, 158, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        pointBackgroundColor: 'var(--chart-green)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'hour', tooltipFormat: 'MMM d, h:mm a', displayFormats: { hour: 'HH:mm' } },
                            grid: { color: 'rgba(255, 255, 255, 0.08)' },
                            ticks: { color: 'var(--text-medium)' }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.08)' },
                            ticks: { color: 'var(--text-medium)' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index', intersect: false,
                            backgroundColor: 'rgba(28, 28, 28, 0.95)',
                            borderColor: 'rgba(255, 255, 255, 0.1)', borderWidth: 1,
                            titleFont: { size: 14, weight: 'bold' }, bodyFont: { size: 12 }, padding: 10,
                            callbacks: {
                                title: (ctx) => new Date(ctx[0].parsed.x).toLocaleString('es-ES', { dateStyle: 'medium', timeStyle: 'short'})
                            }
                        }
                    },
                    interaction: { mode: 'index', intersect: false }
                }
            });
        }
        
        /*
        // --- FUNCIÓN DE PLANTILLA PARA EL GRÁFICO DE DISCOVERY ---
        // Esta función está lista para usarse. Necesitas una API que devuelva los datos.
        // El formato esperado de `discoveryData` es un array de objetos:
        // [{ category: 'Nombre Categoria', position: 1, start: '2025-06-07T12:00:00Z', end: '2025-06-07T16:00:00Z' }, ...]
        
        function createDiscoveryChart(discoveryData) {
            if (myDiscoveryChart) myDiscoveryChart.destroy();

            const discoverySection = document.getElementById('discoveryChartSection');
            if (!discoveryData || discoveryData.length === 0) {
                discoverySection.classList.add('hidden');
                return;
            }
            discoverySection.classList.remove('hidden');

            const ctx = document.getElementById('discoveryChart').getContext('2d');
            
            const categories = [...new Set(discoveryData.map(item => item.category))];
            const datasets = categories.map(cat => {
                return {
                    label: cat,
                    data: discoveryData
                        .filter(item => item.category === cat)
                        .map(item => ({
                            x: [new Date(item.start), new Date(item.end)],
                            y: cat,
                            position: item.position // Dato extra para el tooltip
                        })),
                    backgroundColor: 'var(--chart-blue)'
                };
            });

            myDiscoveryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: datasets
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: {
                            type: 'time',
                            min: dateFns.subDays(new Date(), 1), // Rango por defecto
                            max: new Date(),
                            time: { unit: 'hour' },
                            grid: { color: 'rgba(255, 255, 255, 0.08)' },
                            ticks: { color: 'var(--text-medium)' }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.08)' },
                            ticks: { color: 'var(--text-light)' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                             callbacks: {
                                title: (ctx) => ctx[0].raw.y,
                                label: (ctx) => {
                                    const start = new Date(ctx.raw.x[0]);
                                    const end = new Date(ctx.raw.x[1]);
                                    const durationMs = end - start;
                                    const durationMin = Math.round(durationMs / 60000);
                                    
                                    let formattedDuration = `${durationMin}m`;
                                    if (durationMin >= 60) {
                                        const hours = Math.floor(durationMin / 60);
                                        const mins = durationMin % 60;
                                        formattedDuration = `${hours}h ${mins}m`;
                                    }

                                    return [
                                        `Position: #${ctx.raw.position}`,
                                        `Start: ${start.toLocaleString()}`,
                                        `End: ${end.toLocaleString()}`,
                                        `Duration: ${formattedDuration}`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }
        */

        // --- DOM & LOCALSTORAGE FUNCTIONS (Helpers) ---
        function displayMapDetails(island) {
            let tool = 'Creative';
            if (island.type === 'valkyrie:application') tool = 'UEFN';
            else if (island.type) tool = island.type.toUpperCase();
            const pegiRating = island.ratings?.boards?.PEGI?.rating.replace('PEGI_AGE_', '') ?? 'N/A';

            document.getElementById("mapTitle").innerText = island.title || "Untitled Map";
            document.getElementById("mapCreator").innerText = island.creator || "Unknown Creator";
            document.getElementById("mapDescription").innerText = island.description || "No description.";
            document.getElementById("mapTool").innerText = tool;
            document.getElementById("mapReleaseDate").innerText = island.publishedDate ? new Date(island.publishedDate).toLocaleDateString() : 'N/A';
            document.getElementById("mapAgeRating").innerText = pegiRating;
            document.getElementById("mapXPStatus").innerText = island.xp?.enabled ? 'Awarding XP' : 'No XP';
            document.getElementById("mapCodeDisplay").innerText = island.code;
            document.getElementById("playNowButton").href = `https://www.fortnite.com/play/island/${island.code}`;
            document.getElementById("mapImage").src = island.image || '';

            const tagsContainer = document.getElementById("mapTags");
            tagsContainer.innerHTML = "";
            if (island.tags?.length > 0) {
                island.tags.forEach(tag => {
                    tagsContainer.innerHTML += `<span class="tag">${tag}</span>`;
                });
            }
            
            document.getElementById('mapDetails').classList.remove("hidden");
        }
        function saveSearchHistory(map) {
            searchHistory = searchHistory.filter(m => m.code !== map.code);
            searchHistory.unshift(map);
            if (searchHistory.length > 5) searchHistory.pop();
            localStorage.setItem("searchHistory", JSON.stringify(searchHistory));
            renderSearchHistory();
        }
        function renderSearchHistory() {
            const container = document.getElementById("searchHistory");
            const section = document.getElementById("historySection");
            if (searchHistory.length === 0) {
                section.classList.add("hidden");
                return;
            }
            section.classList.remove("hidden");
            container.innerHTML = searchHistory.map(map => `<li class="list-item"><div class="info"><button onclick="fetchMapDetails('${map.code}')">${map.title}</button><p>${map.code}</p></div></li>`).join("");
        }
        function saveFavorite() {
            const mapCode = document.getElementById("mapCodeDisplay").innerText;
            const mapTitle = document.getElementById("mapTitle").innerText;
            if (!mapCode || !mapTitle) return;
            if (!favoriteMaps.find(m => m.code === mapCode)) {
                favoriteMaps.push({ code: mapCode, title: mapTitle });
                localStorage.setItem("favoriteMaps", JSON.stringify(favoriteMaps));
                renderFavorites();
            } else { showError("This map is already in your favorites.", false); }
        }
        function removeFavorite(code) {
            favoriteMaps = favoriteMaps.filter(m => m.code !== code);
            localStorage.setItem("favoriteMaps", JSON.stringify(favoriteMaps));
            renderFavorites();
        }
        function renderFavorites() {
            const container = document.getElementById("favoriteMaps");
            const section = document.getElementById("favoritesSection");
            if (favoriteMaps.length === 0) {
                section.classList.add("hidden");
                return;
            }
            section.classList.remove("hidden");
            container.innerHTML = favoriteMaps.map(map => `<li class="list-item"><div class="info"><button onclick="fetchMapDetails('${map.code}')">${map.title}</button><p>${map.code}</p></div><button onclick="removeFavorite('${map.code}')" class="remove-btn"><i class="fa-solid fa-trash-can"></i></button></li>`).join("");
        }
        function copyCode() {
            navigator.clipboard.writeText(document.getElementById('mapCodeDisplay').innerText).then(() => showError('Map code copied!', false));
        }
        function showError(message, isError = true) {
            const el = document.getElementById("errorAlert");
            document.getElementById("errorText").innerText = message;
            el.style.backgroundColor = isError ? 'var(--red-error)' : 'var(--green-success)';
            el.classList.remove("hidden");
        }
        function dismissError() {
            document.getElementById("errorAlert").classList.add("hidden");
        }
    </script>
</body>
</html>
